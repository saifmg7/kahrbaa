<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة رواتب الشركة العامة لتوزيع كهرباء بغداد / الصدر - الكرخ - الرصافة</title>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2584764677074031" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .result-item:last-child { border-bottom: none; }
        .result-label { font-weight: 600; color: #4b5563; }
        .result-value { font-weight: 700; color: #1f2937; background-color: #f3f4f6; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.9rem; }
        .total-salary { background-color: #10B981; color: white; }
        .deduction-item .result-label { color: #ef4444; }
        .deduction-item .result-value { background-color: #fee2e2; color: #b91c1c; }
        #gemini-result h4 { font-size: 1.1rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; color: #1d4ed8; }
        #gemini-result ul { list-style-type: disc; margin-right: 1.5rem; margin-bottom: 1rem; }
        #gemini-result li { margin-bottom: 0.5rem; }

        @media print {
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print, header .no-print-badge, footer, form, #gemini-action { display: none !important; }
            .main-container { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
            #results { display: block !important; margin-top: 0 !important; }
            .result-item, #results > div { border-color: #999; }
             .total-salary { background-color: #10B981 !important; color: white !important; }
            .deduction-item .result-value { background-color: #fee2e2 !important; color: #b91c1c !important; }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 main-container relative overflow-hidden">
        
        <!-- خلفية زخرفية خفيفة -->
        <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500 rounded-bl-full opacity-5 pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-32 h-32 bg-teal-500 rounded-tr-full opacity-5 pointer-events-none"></div>

        <header class="text-center mb-8 relative z-10">
            <!-- الشعار (تم تصميمه بالـ HTML و CSS بالكامل ليظهر دائماً) -->
            <div class="flex justify-center mb-6">
                <div class="w-32 h-32 md:w-40 md:h-40 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full shadow-lg border-4 border-white flex flex-col items-center justify-center relative overflow-hidden">
                    <!-- حلقة داخلية -->
                    <div class="absolute inset-2 border-2 border-blue-100/50 rounded-full"></div>
                    <!-- صاعقة الكهرباء (Lightning SVG) -->
                    <svg class="w-16 h-16 md:w-20 md:h-20 text-white z-10 drop-shadow-md" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                    </svg>
                    <!-- النص الإنجليزي أسفل الصاعقة -->
                    <div class="absolute bottom-2 md:bottom-3 text-white font-black text-xs md:text-sm tracking-widest z-10 drop-shadow">B.E.D.C</div>
                </div>
            </div>

            <!-- شارة الرعاية -->
            <div class="mb-5 no-print-badge inline-flex items-center gap-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 px-6 py-3 rounded-full shadow-sm">
                <!-- شعار ACCE (تم تكبيره بالـ CSS) -->
                <div class="w-12 h-12 md:w-14 md:h-14 rounded-full border-[3px] border-white shadow-md bg-[#0f172a] flex items-center justify-center relative overflow-hidden shrink-0">
                    <div class="absolute inset-0 rounded-full border border-[#d4af37] opacity-40"></div>
                    <div class="absolute w-[60%] h-full border-l border-r border-[#d4af37] rounded-[100%] opacity-40"></div>
                    <div class="absolute w-full h-px bg-[#d4af37] opacity-40"></div>
                    <span class="text-[#d4af37] font-bold text-xs md:text-sm tracking-tighter z-10 font-sans mt-[1px]">ACCE</span>
                </div>
                <span class="text-blue-900 font-bold text-base md:text-lg tracking-wide">هذا البرنامج برعاية شركة ACCE</span>
            </div>

            <div class="flex justify-center items-center gap-3">
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800 leading-tight">حاسبة رواتب الشركة العامة<br/><span class="text-blue-600 text-xl md:text-2xl">لتوزيع كهرباء بغداد</span></h1>
            </div>
            <p class="text-gray-500 mt-3 font-medium">للأفرع: الصدر - الكرخ - الرصافة</p>
        </header>

        <form id="salaryForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
            
            <div>
                <label for="jobGrade" class="block text-sm font-bold text-gray-700 mb-2">الدرجة الوظيفية</label>
                <select id="jobGrade" name="jobGrade" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white shadow-sm" required>
                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                    <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    <option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
                </select>
            </div>
            <div>
                <label for="serviceStage" class="block text-sm font-bold text-gray-700 mb-2">المرحلة (سنوات الخدمة)</label>
                <select id="serviceStage" name="serviceStage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white shadow-sm" required>
                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                    <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                    <option value="10">10</option><option value="11">11</option>
                </select>
            </div>

            <div>
                <label for="jobType" class="block text-sm font-bold text-gray-700 mb-2">طبيعة العمل</label>
                <select id="jobType" name="jobType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white shadow-sm">
                    <option value="field">ميداني / خارج المقر</option>
                    <option value="office">كاتب / داخل المقر</option>
                </select>
            </div>

            <div>
                <label for="certificate" class="block text-sm font-bold text-gray-700 mb-2">التحصيل الدراسي</label>
                <select id="certificate" name="certificate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white shadow-sm">
                    <option value="primary">ابتدائية / متوسطة / بدون</option>
                    <option value="highschool">اعدادية</option>
                    <option value="diploma">دبلوم</option>
                    <option value="bachelor">بكالوريوس</option>
                    <option value="master">ماجستير</option>
                    <option value="doctorate">دكتوراه</option>
                </select>
            </div>
            
            <div class="col-span-1 md:col-span-2 flex items-center bg-blue-50 border border-blue-100 p-4 rounded-xl transition hover:shadow-md">
                <input type="checkbox" id="isEngineer" name="isEngineer" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="isEngineer" class="ml-3 mr-3 text-sm font-bold text-blue-900 cursor-pointer w-full">هل الموظف مهندس؟ <span class="text-blue-600 font-normal">(لتفعيل المخصصات الهندسية)</span></label>
            </div>

            <div class="col-span-1 md:col-span-2 grid grid-cols-2 gap-4 items-center bg-gray-50 border border-gray-200 p-4 rounded-xl transition hover:shadow-md">
                <div class="flex items-center">
                    <input type="checkbox" id="isMarried" name="isMarried" class="h-5 w-5 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                    <label for="isMarried" class="ml-3 mr-3 text-sm font-bold text-gray-800 cursor-pointer w-full">متزوج/ة؟</label>
                </div>
                <div id="childrenDiv" class="hidden transition-all">
                    <label for="childrenCount" class="block text-sm font-bold text-gray-700 mb-2">عدد الأطفال</label>
                    <input type="number" id="childrenCount" name="childrenCount" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500" value="0" min="0">
                </div>
            </div>

            <div class="col-span-1 md:col-span-2 grid grid-cols-2 gap-4 mt-2">
                 <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:-translate-y-1">
                    احسب الراتب
                </button>
                 <button type="reset" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-transform transform hover:-translate-y-1">
                    إعادة تعيين
                </button>
            </div>
        </form>

        <div id="results" class="mt-10 hidden relative z-10">
            <h2 class="text-2xl font-extrabold text-center text-gray-800 mb-6 border-b-2 border-gray-100 pb-3">تفاصيل الراتب</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 divide-y divide-gray-100 overflow-hidden">
                <div class="result-item">
                    <span class="result-label">الدرجة / المرحلة</span>
                    <span class="result-value" id="gradeStageResult"></span>
                </div>
                <div class="result-item bg-gray-50">
                    <span class="result-label">الراتب الاسمي</span>
                    <span class="result-value" id="baseSalaryResult"></span>
                </div>
                 <div class="result-item">
                    <span class="result-label">المسمى الوظيفي</span>
                    <span class="result-value" id="jobTitleResult"></span>
                </div>
                <div class="result-item bg-gray-50">
                    <span class="result-label">مخصصات الخطورة</span>
                    <span class="result-value" id="riskAllowanceResult"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">مخصصات بريمر</span>
                    <span class="result-value" id="primerAllowanceResult"></span>
                </div>
                <div class="result-item bg-gray-50">
                    <span class="result-label">مخصصات الشهادة</span>
                    <span class="result-value" id="certificateAllowanceResult"></span>
                </div>
                <div class="result-item" id="higherDegreeItem" style="display: none;">
                    <span class="result-label">مخصصات شهادة عليا</span>
                    <span class="result-value" id="higherDegreeAllowanceResult"></span>
                </div>
                <div class="result-item bg-gray-50" id="engineeringItem" style="display: none;">
                    <span class="result-label">المخصصات الهندسية</span>
                    <span class="result-value" id="engineeringAllowanceResult"></span>
                </div>
                <div class="result-item bg-gray-50" id="maritalItem" style="display: none;">
                    <span class="result-label">مخصصات الزوجية</span>
                    <span class="result-value" id="maritalAllowanceResult"></span>
                </div>
                <div class="result-item" id="childrenItem" style="display: none;">
                    <span class="result-label">مخصصات الأطفال</span>
                    <span class="result-value" id="childrenAllowanceResult"></span>
                </div>
                 <div class="result-item bg-blue-50 border-t-2 border-blue-100">
                    <span class="result-label text-blue-800 font-bold">مجموع المخصصات</span>
                    <span class="result-value text-blue-700 bg-blue-100" id="totalAllowancesResult"></span>
                </div>
                 <div class="result-item">
                    <span class="result-label font-bold text-lg text-gray-800">الراتب الإجمالي</span>
                    <span class="result-value font-bold text-lg bg-gray-200" id="grossSalaryResult"></span>
                </div>
                 <div class="result-item deduction-item bg-red-50">
                    <span class="result-label">استقطاع 10% التقاعد (من الاسمي)</span>
                    <span class="result-value" id="deduction10Result"></span>
                </div>
                <div class="result-item deduction-item">
                    <span class="result-label">استقطاع نادي الكهرباء</span>
                    <span class="result-value" id="clubDeductionResult"></span>
                </div>
                 <div class="result-item deduction-item bg-red-50">
                    <span class="result-label">استقطاع إضافي</span>
                    <span class="result-value" id="otherDeductionResult"></span>
                </div>
                 <div class="result-item deduction-item border-t-2 border-red-100">
                    <span class="result-label font-bold">مجموع الاستقطاعات</span>
                    <span class="result-value font-bold bg-red-200 text-red-800" id="totalDeductionsResult"></span>
                </div>
                <div class="result-item total-salary p-5 shadow-inner">
                    <span class="result-label text-white text-xl font-extrabold">الراتب الصافي</span>
                    <span class="result-value bg-white text-emerald-600 text-2xl font-black px-4 py-2 rounded-lg shadow-sm" id="netSalaryResult"></span>
                </div>
            </div>
            
            <div class="mt-6 flex flex-col md:flex-row gap-4 justify-center no-print">
                <button onclick="window.print()" class="bg-teal-500 text-white font-bold py-3 px-6 rounded-xl shadow hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-400 transition-transform transform hover:-translate-y-1 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                    </svg>
                    طباعة النتائج
                </button>
            </div>
            
            <div id="gemini-action" class="mt-6 text-center no-print hidden border-t-2 border-dashed border-gray-200 pt-6">
                <h3 class="text-lg font-bold text-gray-700 mb-3">هل ترغب في إدارة راتبك بذكاء؟</h3>
                <button id="getPlanBtn" class="w-full md:w-auto inline-block bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:from-purple-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:-translate-y-1">
                    ✨ إنشاء خطة مالية شهرية ذكية
                </button>
            </div>
        </div>
    </main>

    <!-- نافذة الذكاء الاصطناعي (Modal) -->
    <div id="gemini-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95 border-t-4 border-indigo-500">
            <div class="flex justify-between items-center p-5 border-b border-gray-100 bg-gray-50 rounded-t-2xl">
                <h3 class="text-xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600 flex items-center gap-2">
                    ✨ خطتك المالية المقترحة
                </h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full w-8 h-8 flex items-center justify-center text-3xl font-bold transition-colors">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar" id="gemini-content-area">
                <div id="loading-spinner" class="flex flex-col justify-center items-center h-48 gap-4">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600"></div>
                    <p class="text-indigo-600 font-bold animate-pulse">جاري تحليل البيانات وإعداد الخطة المخصصة لك...</p>
                </div>
                <div id="gemini-result" class="prose prose-indigo max-w-none text-gray-700 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-10 mb-6 text-gray-500 text-sm">
        <div class="flex flex-col justify-center items-center gap-2">
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-2 rounded-lg font-bold mb-1 shadow-sm text-sm">
                ⚠️ ملاحظة: هذا البرنامج من صنع أحد الموظفين لتسهيل العمل وليس برنامجاً رسمياً صادراً من الشركة.
            </div>
            <p class="font-semibold text-gray-600">تم تطوير البرنامج من قبل المهندس سيف الزيدي &copy; 2026</p>
            <a href="https://www.facebook.com/engsaif99/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 transition flex items-center gap-1 bg-white px-3 py-1 rounded-full shadow-sm border border-gray-200">
                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" />
                </svg>
                <span class="font-bold">تواصل معي</span>
            </a>
        </div>
    </footer>

    <script>
        const form = document.getElementById('salaryForm');
        const resultsDiv = document.getElementById('results');
        const isMarriedCheckbox = document.getElementById('isMarried');
        const childrenDiv = document.getElementById('childrenDiv');
        const childrenCountInput = document.getElementById('childrenCount');
        const geminiModal = document.getElementById('gemini-modal');
        const geminiActionDiv = document.getElementById('gemini-action');
        let currentNetSalary = 0;

        const salaryScale = {
            '1': { '1': 910, '2': 930, '3': 950, '4': 970, '5': 990, '6': 1010, '7': 1030, '8': 1050, '9': 1070, '10': 1090, '11': 1110 },
            '2': { '1': 723, '2': 740, '3': 757, '4': 774, '5': 791, '6': 808, '7': 825, '8': 842, '9': 859, '10': 876, '11': 893 },
            '3': { '1': 600, '2': 610, '3': 620, '4': 630, '5': 640, '6': 650, '7': 660, '8': 670, '9': 680, '10': 690, '11': 700 },
            '4': { '1': 509, '2': 517, '3': 525, '4': 533, '5': 541, '6': 549, '7': 557, '8': 565, '9': 573, '10': 581, '11': 589 },
            '5': { '1': 429, '2': 435, '3': 441, '4': 447, '5': 453, '6': 459, '7': 465, '8': 471, '9': 477, '10': 483, '11': 489 },
            '6': { '1': 362, '2': 368, '3': 374, '4': 380, '5': 386, '6': 392, '7': 398, '8': 404, '9': 410, '10': 416, '11': 422 },
            '7': { '1': 296, '2': 302, '3': 308, '4': 314, '5': 320, '6': 326, '7': 332, '8': 338, '9': 344, '10': 350, '11': 356 },
            '8': { '1': 260, '2': 263, '3': 266, '4': 269, '5': 272, '6': 275, '7': 278, '8': 281, '9': 284, '10': 287, '11': 290 },
            '9': { '1': 210, '2': 213, '3': 216, '4': 219, '5': 222, '6': 225, '7': 228, '8': 231, '9': 234, '10': 237, '11': 240 },
            '10': { '1': 170, '2': 173, '3': 176, '4': 179, '5': 182, '6': 185, '7': 188, '8': 191, '9': 194, '10': 197, '11': 200 }
        };

        isMarriedCheckbox.addEventListener('change', function() {
            childrenDiv.classList.toggle('hidden', !this.checked);
            if (!this.checked) childrenCountInput.value = 0;
        });
        
        form.addEventListener('reset', function() {
            resultsDiv.classList.add('hidden');
            geminiActionDiv.classList.add('hidden');
            childrenDiv.classList.add('hidden');
        });

        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const jobGrade = document.getElementById('jobGrade').value;
            const serviceStage = document.getElementById('serviceStage').value;
            const jobType = document.getElementById('jobType').value;
            const certificate = document.getElementById('certificate').value;
            const isEngineer = document.getElementById('isEngineer').checked;
            const isMarried = document.getElementById('isMarried').checked;
            const childrenCount = parseInt(document.getElementById('childrenCount').value) || 0;
            
            const baseSalaryRaw = salaryScale[jobGrade]?.[serviceStage];
            if (!baseSalaryRaw) {
                console.error("الراتب لهذه الدرجة والمرحلة غير محدد في الجدول.");
                return;
            }
            
            const baseSalary = baseSalaryRaw * 1000;
            const riskAllowance = baseSalary * ((jobType === 'field') ? 0.65 : 0.56);
            const primerAllowance = baseSalary * 0.30;
            let certPercentage;
            let jobTitle;
            
            switch (certificate) {
                case 'highschool': certPercentage = 0.25; jobTitle = 'فني'; break;
                case 'diploma': certPercentage = 0.35; jobTitle = 'فني أقدم'; break;
                case 'bachelor': certPercentage = 0.50; jobTitle = 'غير محدد'; break;
                case 'master': certPercentage = 0.75; jobTitle = 'باحث / خبير'; break;
                case 'doctorate': certPercentage = 1.00; jobTitle = 'خبير استشاري'; break;
                default: certPercentage = 0.15; jobTitle = 'حرفي'; break;
            }
            
            const certificateAllowance = baseSalary * certPercentage;
            
            let higherDegreeAllowance = 0;
            if (certificate === 'master' || certificate === 'doctorate') {
                higherDegreeAllowance = baseSalary * 0.50;
            }

            let engineeringAllowance = 0;
            const engineeringItem = document.getElementById('engineeringItem');
            
            if (isEngineer) {
                const engPercentage = (jobType === 'field') ? 0.50 : 0.35;
                engineeringAllowance = baseSalary * engPercentage;
                engineeringItem.style.display = 'flex';
            } else {
                 engineeringItem.style.display = 'none';
            }
            
            const maritalAllowance = isMarried ? 50000 : 0;
            const childrenAllowance = isMarried ? childrenCount * 10000 : 0;
            
            const maritalItem = document.getElementById('maritalItem');
            maritalItem.style.display = isMarried ? 'flex' : 'none';
            
            const childrenItem = document.getElementById('childrenItem');
            childrenItem.style.display = isMarried && childrenCount > 0 ? 'flex' : 'none';
            
            const totalAllowances = riskAllowance + primerAllowance + certificateAllowance + higherDegreeAllowance + engineeringAllowance + maritalAllowance + childrenAllowance;
            const grossSalary = baseSalary + totalAllowances;
            const deduction10 = baseSalary * 0.10;
            const clubDeduction = 2000;
            const otherDeduction = 500;
            const totalDeductions = deduction10 + clubDeduction + otherDeduction;
            const netSalary = grossSalary - totalDeductions;
            currentNetSalary = netSalary;
            
            const formatter = new Intl.NumberFormat('ar-IQ', { style: 'currency', currency: 'IQD', minimumFractionDigits: 0 });
            
            document.getElementById('gradeStageResult').textContent = `${jobGrade} / ${serviceStage}`;
            document.getElementById('baseSalaryResult').textContent = formatter.format(baseSalary);
            document.getElementById('jobTitleResult').textContent = jobTitle;
            document.getElementById('riskAllowanceResult').textContent = formatter.format(riskAllowance);
            document.getElementById('primerAllowanceResult').textContent = formatter.format(primerAllowance);
            document.getElementById('certificateAllowanceResult').textContent = formatter.format(certificateAllowance);
            
            const higherDegreeItemUI = document.getElementById('higherDegreeItem');
            if(higherDegreeAllowance > 0) {
                document.getElementById('higherDegreeAllowanceResult').textContent = formatter.format(higherDegreeAllowance);
                higherDegreeItemUI.style.display = 'flex';
            } else {
                higherDegreeItemUI.style.display = 'none';
            }

            if(isEngineer) document.getElementById('engineeringAllowanceResult').textContent = formatter.format(engineeringAllowance);
            if(isMarried) document.getElementById('maritalAllowanceResult').textContent = formatter.format(maritalAllowance);
            if(isMarried && childrenCount > 0) document.getElementById('childrenAllowanceResult').textContent = formatter.format(childrenAllowance);
            
            document.getElementById('totalAllowancesResult').textContent = formatter.format(totalAllowances);
            document.getElementById('grossSalaryResult').textContent = formatter.format(grossSalary);
            document.getElementById('deduction10Result').textContent = formatter.format(deduction10);
            document.getElementById('clubDeductionResult').textContent = formatter.format(clubDeduction);
            document.getElementById('otherDeductionResult').textContent = formatter.format(otherDeduction);
            document.getElementById('totalDeductionsResult').textContent = formatter.format(totalDeductions);
            document.getElementById('netSalaryResult').textContent = formatter.format(netSalary);

            resultsDiv.classList.remove('hidden');
            geminiActionDiv.classList.remove('hidden');
            
            // التمرير السلس إلى النتائج
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // --- Gemini API Integration ---
        document.getElementById('getPlanBtn').addEventListener('click', () => getFinancialPlan(currentNetSalary));
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            geminiModal.classList.add('hidden');
            geminiModal.querySelector('.transform').classList.add('scale-95');
        });
        
        // دالة الاتصال المتقدمة مع إعادة المحاولة
        async function fetchWithBackoff(url, options, retries = 5) {
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }

        async function getFinancialPlan(netSalary) {
            const loadingSpinner = document.getElementById('loading-spinner');
            const resultDiv = document.getElementById('gemini-result');
            
            geminiModal.classList.remove('hidden');
            setTimeout(() => geminiModal.querySelector('.transform').classList.remove('scale-95'), 10);
            
            loadingSpinner.style.display = 'flex';
            resultDiv.innerHTML = '';

            // سيتم تزويد مفتاح API تلقائياً من بيئة التشغيل
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const prompt = `بصفتك خبير مالي، قم بإنشاء خطة ميزانية شهرية بسيطة ومفصلة لشخص يعيش في بغداد، العراق، وراتبه الصافي هو ${netSalary.toLocaleString('ar-IQ')} دينار عراقي. 
            استخدم التنسيق التالي بدقة:
            - مقدمة تشجيعية قصيرة (سطر أو سطرين).
            - عنوان "**تفاصيل الميزانية المقترحة:**"
            - قائمة نقطية لكل فئة (مثل: **السكن:** 25% - 30% | حوالي X دينار). غطي الفئات الأساسية (السكن/الإيجار، الفواتير، الطعام، النقل، الصحة) والثانوية (التعليم/التطوير، الترفيه، الادخار، الطوارئ).
            - عنوان "**3 نصائح ذهبية للالتزام بالميزانية في بغداد:**"
            - قائمة مرقمة لثلاث نصائح عملية ومختصرة تراعي طبيعة المعيشة في بغداد.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const result = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    resultDiv.innerHTML = simpleMarkdownToHtml(text);
                } else {
                    resultDiv.innerHTML = '<p class="text-red-500 font-bold text-center">عذراً، لم نتمكن من إنشاء الخطة. يرجى المحاولة مرة أخرى.</p>';
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                resultDiv.innerHTML = `<div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <p class="text-red-600 text-center font-bold">حدث خطأ أثناء الاتصال بالخدمة الذكية.</p>
                    <p class="text-red-500 text-center text-sm mt-1">يرجى التأكد من اتصالك بالإنترنت أو المحاولة لاحقاً.</p>
                </div>`;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
        
        function simpleMarkdownToHtml(text) {
             return text
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-indigo-800">$1</strong>') 
                .replace(/^- (.*$)/gm, '<li class="mb-2">$1</li>')
                .replace(/(\<li class="mb-2"\>.*?\<\/li\>)/gs, '<ul class="list-disc list-inside space-y-1 mb-4 text-gray-700">$1</ul>')
                .replace(/^\d+\. (.*$)/gm, '<li class="mb-2">$1</li>')
                .replace(/(<ol>[\s\S]*)?<li>(.*?)<\/li>/gs, (match, p1) => p1 ? match : `<ol class="list-decimal list-inside space-y-2 mb-4 text-gray-700 font-medium">${match}</ol>`)
                .replace(/\n/g, '<br>');
        }
    </script>
</body>
</html>
